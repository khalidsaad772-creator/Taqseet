<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø­Ù„ Ø§Ù„ØªÙ‚Ø³ÙŠØ· - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<style>
/* CSS Reset and Global Styles */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Tahoma, Arial, sans-serif;background:#f0f8ff;padding:10px}
.container{max-width:550px;margin:0 auto;background:white;border-radius:16px;padding:20px;box-shadow:0 6px 25px rgba(0,0,0,0.15)}
h1{color:#28a745;text-align:center;margin:20px 0;font-size:26px}
h2{color:#007bff;text-align:center;margin:15px 0;font-size:20px}

/* Form and Button Styles */
input,button{width:100%;padding:14px;margin:8px 0;border:2px solid #28a745;border-radius:12px;font-size:16px;text-align:center}
button{background:#28a745;color:#fff;font-weight:bold;cursor:pointer;transition:background .3s}
button:hover{background:#1e7e34}
.backup-btn{background:#ff9800!important}.restore-btn{background:#9c27b0!important}
.btn{padding:8px 14px;margin:4px;font-size:14px;border-radius:10px;font-weight:bold;cursor:pointer}
.pay{background:#007bff}.wa{background:#25D366}.edit{background:#ffc107;color:#000}.del{background:#dc3545}
.wa:hover{background:#1dbe52}.pay:hover{background:#0056b3}.del:hover{background:#c82333}

/* Result and Table Styles */
.result{background:#d4edda;color:#155724;padding:16px;border-radius:12px;margin:15px 0;text-align:center;font-size:18px;font-weight:bold}
table{width:100%;border-collapse:collapse;margin:15px 0;font-size:14px;border-radius:12px;overflow:hidden}
th{background:#28a745;color:#fff;padding:12px}
td{border:1px solid #ddd;padding:10px;text-align:center;background:#f9f9f9}
.action-row td{background:#e9ecef;padding:12px}
.action-content{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.progress{height:10px;background:#eee;border-radius:5px;overflow:hidden;margin:8px 0}
.bar{height:100%;background:#28a745;transition:width .6s}
.product-desc{font-size:13px;color:#555;display:block;margin-top:4px}

/* Image and Modal Styles */
.client-thumb{width:40px;height:40px;border-radius:50%;object-fit:cover;border:3px solid #28a745;cursor:pointer}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1000}
.modal-content{background:white;padding:25px;border-radius:16px;width:90%;max-width:450px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
.hidden{display:none!important}
#previewImage, #fullImage{max-width:100%;margin-top:15px;border-radius:12px;border:3px solid #28a745}
</style>
</head>
<body>
<div class="container">
<h1>Ù…Ø­Ù„ Ø§Ù„ØªÙ‚Ø³ÙŠØ· ğŸ’°</h1>
<input type="text" id="name" placeholder="* Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
<input type="text" id="phone" placeholder="* Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† (11 Ø±Ù‚Ù…)" required>
<input type="text" id="product" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø«Ø§Ù„: Ù‡Ø§ØªÙ Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬ A12)">
<input type="number" id="price" value="10000" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø³Ù„Ø¹Ø© (Ø£ØµÙ„ Ø§Ù„Ù…Ø¨Ù„Øº)">
<input type="number" id="months" value="10" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡ÙˆØ±">
<input type="number" id="interest" value="25" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© % (Ù…Ø«Ø§Ù„: 25)">
<button onclick="addClient()">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
<button onclick="exportPDF()">Export PDF Report ğŸ“„</button>
<div style="display:flex; gap:10px; margin-top:10px">
    <button class="backup-btn" onclick="exportData()" style="flex:1">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ğŸ’¾</button>
    <button class="restore-btn" onclick="document.getElementById('restoreInput').click()" style="flex:1">Ø§Ø³ØªØ¹Ø§Ø¯Ø© â™»ï¸</button>
</div>
<input type="file" id="restoreInput" accept=".json" onchange="restoreData(event)" style="display:none">

<h2>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</h2>
<div id="res" class="result">0 Ø¬Ù†ÙŠÙ‡</div>

<h2>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ</h2>
<div id="monthlyRes" class="result" style="background:#fff3cd; color:#856404;">0 Ø¬Ù†ÙŠÙ‡</div>

<h2 id="clientsCount">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (0)</h2>
<div id="clientsTable"></div>
</div>

<div id="editModal" class="modal hidden"><div class="modal-content"><h2>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2><input id="editName"><input id="editPhone"><input id="editProduct"><input id="editPrice" type="number"><input id="editMonths" type="number"><input id="editInterest" type="number"><button onclick="saveClient()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button><button onclick="closeModal('editModal')" style="background:#dc3545">Ø¥Ù„ØºØ§Ø¡ ÙˆØ¥ØºÙ„Ø§Ù‚</button></div></div>

<div id="paymentModal" class="modal hidden"><div class="modal-content"><h2>Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· Ø¬Ø¯ÙŠØ¯</h2><input id="paymentAmount" type="number" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹"><input id="paymentDate" type="date"><button onclick="addPayment()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ø·</button><button onclick="closeModal('paymentModal')" style="background:#dc3545">Ø¥ØºÙ„Ø§Ù‚</button></div></div>

<div id="photoModal" class="modal hidden"><div class="modal-content"><h2>ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© (Ù…Ù„Ø§Ø­Ø¸Ø©)</h2><img id="previewImage" class="hidden"><button style="background:#17a2b8" onclick="document.getElementById('photoInput').click()">Ø§Ø®ØªØ± ØµÙˆØ±Ø©</button><input type="file" id="photoInput" accept="image/*" onchange="loadPhoto(event)" style="display:none"><button onclick="savePhoto()" style="background:#28a745">Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button><button onclick="closeModal('photoModal')" style="background:#dc3545">Ø¥ØºÙ„Ø§Ù‚</button></div></div>

<div id="imageModal" class="modal hidden"><div class="modal-content"><img id="fullImage" style="max-width:100%;border-radius:12px"><br><button onclick="closeModal('imageModal')">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙˆØ±Ø©</button></div></div>

<script>
const { jsPDF } = window.jspdf;
let clients = JSON.parse(localStorage.getItem('clients') || '[]');
let currentIndex = -1;
let tempPhoto = null;

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„Ø©
const formatCurrency = (num) => Number(num).toLocaleString('ar-EG', { maximumFractionDigits: 0 }) + ' Ø¬.Ù…';

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
clients = clients.map(c => ({
    name: c.name || "",
    phone: c.phone || "",
    product: c.product || "Ø¨Ø¯ÙˆÙ† ÙˆØµÙ",
    price: Number(c.price) || 0,
    months: Number(c.months) || 10,
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ù…Ø®Ø²Ù†Ø© ÙƒÙ†Ø³Ø¨Ø© Ø¹Ø´Ø±ÙŠØ©
    interest: Number(c.interest) >= 1 ? Number(c.interest) / 100 : Number(c.interest) || 0, 
    paid: Number(c.paid) || 0,
    payments: c.payments || [],
    photo: c.photo || null
}));


function addClient() {
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const product = document.getElementById('product').value.trim() || "Ø¨Ø¯ÙˆÙ† ÙˆØµÙ";
    const price = Number(document.getElementById('price').value);
    const months = Number(document.getElementById('months').value);
    const interest = Number(document.getElementById('interest').value) / 100; // ØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ø¹Ø´Ø±ÙŠØ©

    if (!name || !phone || !price || !months || !interest) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙ„ÙŠÙÙˆÙ† ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø· ÙˆØ§Ù„ÙØ§Ø¦Ø¯Ø©.");
    if (phone.length < 11 || phone.length > 15) return alert("Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† ØºÙŠØ± ØµØ­ÙŠØ­");

    const clean = phone.replace(/\D/g,'');
    // Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ù„Ù€ WhatsApp (+20)
    const full = clean.startsWith('20') ? clean : '20' + clean.replace(/^0/,'');
    const formattedPhone = '+' + full;

    clients.push({name, phone:formattedPhone, product, price, months, interest, paid:0, payments:[], photo:null});
    localStorage.setItem('clients', JSON.stringify(clients));
    document.getElementById('name').value = document.getElementById('phone').value = document.getElementById('product').value = '';
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    document.getElementById('price').value = 10000;
    document.getElementById('months').value = 10;
    document.getElementById('interest').value = 25;
    
    calcProfits();
    showClients();
}

function calcProfits() {
    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
    const totalExpectedProfit = clients.reduce((a,c) => a + c.price * c.interest, 0);
    document.getElementById('res').innerHTML = formatCurrency(totalExpectedProfit);
    
    // Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    document.getElementById('monthlyRes').innerHTML = formatCurrency(getMonthlyProfit());
}

function getNextInstallment(c) {
    const total = c.price * (1 + c.interest);
    const inst = total / c.months;
    const remainingAmount = total - c.paid;

    if (remainingAmount <= 0.01) return "ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯"; // 0.01 Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØªØ¹ÙˆÙŠÙ… Ø§Ù„Ø£Ø±Ù‚Ø§Ù…

    // Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù‚Ø§Ø¯Ù… Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø£ØµØºØ± Ù…Ù† Ø§Ù„Ù‚Ø³Ø·
    return formatCurrency(Math.min(inst, remainingAmount));
}

function getMonthlyProfit() {
    const now = new Date();
    const m = now.getMonth(), y = now.getFullYear();
    let profit = 0;
    
    clients.forEach(c => {
        // Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø¨Ø¯ÙˆÙ† ÙØ§Ø¦Ø¯Ø© (Ø£ØµÙ„ Ø§Ù„Ù…Ø¨Ù„Øº ÙÙ‚Ø·)
        const baseInst = c.price / c.months; 
        // Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ÙƒÙ„ÙŠØ© (Ø£ØµÙ„ + ÙØ§Ø¦Ø¯Ø©)
        const fullInst = (c.price * (1+c.interest)) / c.months; 
        let paidMonth = 0;

        c.payments.forEach(p => {
            const d = new Date(p.date);
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙÙŠ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if (d.getMonth() === m && d.getFullYear() === y) paidMonth += p.amount;
        });

        if(fullInst > 0 && paidMonth > 0) {
             // Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† Ø§Ù„Ù‚Ø³Ø· = (Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ÙƒÙ„ÙŠØ© - Ø£ØµÙ„ Ø§Ù„Ù…Ø¨Ù„Øº) / Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ÙƒÙ„ÙŠØ©
             const profitRatio = (fullInst - baseInst) / fullInst;
             // Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± = (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±) * Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­
             profit += paidMonth * profitRatio;
        }
    });
    return Math.max(0, profit); // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¨Ø­ Ø³Ø§Ù„Ø¨
}

function showClients() {
    document.getElementById('clientsCount').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (${clients.length})`;
    let html = `<table><tr><th>Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬</th><th>ØªÙ„ÙŠÙÙˆÙ†</th><th>Ù…Ø¯ÙÙˆØ¹</th><th>Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù‚Ø§Ø¯Ù…</th></tr>`;
    
    clients.forEach((c,i) => {
        const total = c.price * (1 + c.interest);
        const rem = total - c.paid;
        const pct = total ? (c.paid/total)*100 : 0;
        const thumb = c.photo ? `<img src="${c.photo}" class="client-thumb" onclick="openImageModal('${c.photo}')" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„">` : '';

        html += `
        <tr>
            <td style="text-align:right"><strong>${c.name}</strong><small class="product-desc">${c.product}</small></td>
            <td>${c.phone.replace('+20','0')}</td>
            <td>${formatCurrency(c.paid)}</td>
            <td>${formatCurrency(Math.max(0, rem))}</td>
            <td>${getNextInstallment(c)}</td>
        </tr>
        <tr class="action-row"><td colspan="5">
            <div class="action-content">
                <div class="progress"><div class="bar" style="width:${Math.min(100, pct)}%"></div></div>
                <button class="btn pay" onclick="openPaymentModal(${i})">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø·</button>
                <button class="btn edit" onclick="editClient(${i})">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button class="btn wa" onclick="sendWA(${i})">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³</button>
                <button class="btn del" onclick="deleteClient(${i})">Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                <button class="btn cam" onclick="openPhotoModal(${i})">ØµÙˆØ±Ø©/Ù…Ù„Ø§Ø­Ø¸Ø©</button>
                ${thumb}
            </div>
        </td></tr>`;
    });
    html += `</table>`;
    document.getElementById('clientsTable').innerHTML = html;
}

function deleteClient(i){if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")){clients.splice(i,1);localStorage.setItem('clients',JSON.stringify(clients));calcProfits();showClients();}}

function editClient(i){
    currentIndex=i;
    const c=clients[i];
    document.getElementById('editName').value=c.name;
    document.getElementById('editPhone').value=c.phone.replace('+','');
    document.getElementById('editProduct').value=c.product;
    document.getElementById('editPrice').value=c.price;
    document.getElementById('editMonths').value=c.months;
    // Ø¹Ø±Ø¶ Ø§Ù„ÙØ§Ø¦Ø¯Ø© ÙƒÙ†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    document.getElementById('editInterest').value=Math.round(c.interest*100); 
    document.getElementById('editModal').classList.remove('hidden');
}

function saveClient(){
    const c=clients[currentIndex];
    const newInterest = Number(document.getElementById('editInterest').value) / 100;
    
    c.name=document.getElementById('editName').value.trim();
    c.phone='+'+document.getElementById('editPhone').value.replace(/\D/g,'');
    c.product=document.getElementById('editProduct').value.trim()||"Ø¨Ø¯ÙˆÙ† ÙˆØµÙ";
    c.price=Number(document.getElementById('editPrice').value);
    c.months=Number(document.getElementById('editMonths').value);
    c.interest=newInterest;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (!c.name || !c.price || !c.months || c.phone.length < 11) return alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");

    localStorage.setItem('clients',JSON.stringify(clients));
    closeModal('editModal');
    calcProfits();
    showClients();
}

function openPaymentModal(i){
    currentIndex=i;
    // ÙˆØ¶Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    document.getElementById('paymentDate').value=new Date().toISOString().split('T')[0];
    const total = clients[i].price * (1 + clients[i].interest);
    const inst = total / clients[i].months;
    document.getElementById('paymentAmount').value = Math.round(inst); // Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
    document.getElementById('paymentModal').classList.remove('hidden');
}

function addPayment(){
    const amt=Number(document.getElementById('paymentAmount').value);
    const date=document.getElementById('paymentDate').value;
    
    if(!amt||!date || amt <= 0) return alert("Ø§Ù…Ù„Ø£ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");

    clients[currentIndex].payments.push({amount:amt,date});
    clients[currentIndex].paid+=amt;
    
    localStorage.setItem('clients',JSON.stringify(clients));
    closeModal('paymentModal');
    calcProfits();
    showClients();
}

function closeModal(id){document.getElementById(id).classList.add('hidden');}

function sendWA(i){
    const c=clients[i];
    const total=c.price*(1+c.interest);
    const rem=total-c.paid;
    const inst=total/c.months;
    const remainInst=Math.max(0, Math.ceil((total - c.paid) / inst));

    const nextPaymentDate = new Date();
    // Ù‡Ù†Ø§ ÙŠÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù‚Ø§Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…ØŒ ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡Ø§ Ù„ØªØªØ¨Ø¹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ
    nextPaymentDate.setMonth(nextPaymentDate.getMonth()+1);
    
    const msg=`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${c.name}ØŒ Ø¥Ù„ÙŠÙƒ ØªÙØ§ØµÙŠÙ„ ØªÙ‚Ø³ÙŠØ· ${c.product}:\n\nâ€¢ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(Math.max(0, rem))}\nâ€¢ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: ${remainInst} Ù‚Ø³Ø·\nâ€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù‚Ø§Ø¯Ù…: ${getNextInstallment(c)}\n\nØ¨Ø±Ø¬Ø§Ø¡ Ø³Ø±Ø¹Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯. Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§ÙˆÙ†Ùƒ.`;
    
    window.open(`https://wa.me/${c.phone.replace('+','')}/?text=${encodeURIComponent(msg)}`,'_blank');
}

function openPhotoModal(i){currentIndex=i;tempPhoto=null;const img=document.getElementById('previewImage');if(clients[i].photo){img.src=clients[i].photo;img.classList.remove('hidden');}else{img.classList.add('hidden');}document.getElementById('photoModal').classList.remove('hidden');}

function loadPhoto(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{tempPhoto=ev.target.result;document.getElementById('previewImage').src=tempPhoto;document.getElementById('previewImage').classList.remove('hidden');};r.readAsDataURL(f);}

function savePhoto(){if(!tempPhoto)return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„Ø­ÙØ¸Ù‡Ø§");clients[currentIndex].photo=tempPhoto;localStorage.setItem('clients',JSON.stringify(clients));closeModal('photoModal');showClients();}

function openImageModal(src){document.getElementById('fullImage').src=src;document.getElementById('imageModal').classList.remove('hidden');}

function exportPDF(){
    const doc=new jsPDF('p', 'mm', 'a4');
    const profit=getMonthlyProfit();
    
    // Ù„Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ PDF (Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ù…Ø¯Ù…Ø¬)
    doc.setFont('Amiri', 'normal'); 
    
    doc.setFontSize(20);
    // doc.text(Ù†ØµØŒ xØŒ yØŒ {align:'right'}) 
    doc.text("ØªÙ‚Ø±ÙŠØ± Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØªÙ‚Ø³ÙŠØ·", doc.internal.pageSize.getWidth() / 2, 20, {align:'center'}); 
    
    doc.setFontSize(12);
    doc.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-EG')}`, doc.internal.pageSize.getWidth() - 10, 30, {align:'right'});
    
    const data=clients.map(c=>([
        formatCurrency(Math.max(0, c.price*(1+c.interest)-c.paid)), 
        formatCurrency(c.paid),
        c.phone.replace('+20','0'), 
        c.product, 
        c.name
    ]));
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„
    doc.autoTable({
        head:[['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ù…Ù†ØªØ¬','Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†','Ø§Ù„Ù…Ø¯ÙÙˆØ¹','Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ']],
        body:data,
        startY: 40,
        styles: {font: 'Amiri', cellPadding: 2, halign: 'center'},
        headStyles: {fillColor: [40, 167, 69]},
        theme: 'striped',
        // Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±
        didDrawCell: (data) => { if (data.cell.section === 'body') data.cell.text.reverse(); },
        columnStyles: { 
            0: {halign: 'right'}, 
            4: {halign: 'right'} 
        }
    });
    
    doc.setFontSize(16);
    doc.setTextColor(0,100,0);
    doc.text(`ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±: ${formatCurrency(profit)}`, doc.internal.pageSize.getWidth() / 2, doc.lastAutoTable.finalY + 15, {align:'center'});
    
    doc.save(`Report-${new Date().getFullYear()}${new Date().getMonth()+1}.pdf`);
}


function exportData(){
    const b=new Blob([JSON.stringify({clients},null,2)],{type:'application/json'}); // ØªÙ†Ø³ÙŠÙ‚ JSON Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
    const u=URL.createObjectURL(b);
    const a=document.createElement('a');
    a.href=u;
    a.download=`installments_backup_${new Date().toLocaleDateString('en-GB').replace(/\//g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(u);
    alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
}

function restoreData(e){
    const f=e.target.files[0];
    if(!f||!confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±."))return;
    
    const r=new FileReader();
    r.onload=ev=>{
        try{
            const restoredClients = JSON.parse(ev.target.result).clients || [];
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© ØªØ¨Ø¯Ùˆ ØµØ­ÙŠØ­Ø© (ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­ Ø£Ø³Ø§Ø³ÙŠØ©)
            if (restoredClients.length > 0 && restoredClients[0].name !== undefined) {
                 clients = restoredClients.map(c => ({
                    ...c, 
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡Ø§ Ø¹Ø´Ø±ÙŠØ©
                    interest: Number(c.interest) >= 1 ? Number(c.interest) / 100 : Number(c.interest) || 0,
                    price: Number(c.price),
                    months: Number(c.months),
                    paid: Number(c.paid)
                }));

                localStorage.setItem('clients',JSON.stringify(clients));
                calcProfits();
                showClients();
                alert("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
            } else {
                 alert("Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„Ø§Ø¡ ØµØ§Ù„Ø­Ø©.");
            }
        }catch(err){
            alert("ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­. " + err.message);
        }
    };
    r.readAsText(f);
}

window.onload=()=>{calcProfits();showClients();};
</script>
</body>
</html>
