<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محل التقسيط</title>

    <!-- PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#28a745">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png" type="image/png">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f8ff; padding: 10px; font-size: 16px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 20px; }
        h1, h2 { color: #28a745; text-align: center; margin: 20px 0 15px; font-size: 20px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #28a745; border-radius: 12px; font-size: 16px; }
        button { background: #28a745; color: white; font-weight: bold; cursor: pointer; }
        .btn { display: inline-block; width: auto; padding: 8px 12px; margin: 3px; font-size: 14px; border-radius: 8px; }
        .pay { background: #007bff; } .wa { background: #25D366; } .cam { background: #6f42c1; } .edit { background: #ffc107; color: black; } .del { background: #dc3545; }
        .result { background: #d4edda; color: #155724; padding: 15px; border-radius: 12px; margin: 15px 0; text-align: center; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 14px; }
        th { background: #28a745; color: white; padding: 10px; font-size: 14px; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; background: #f9f9f9; }
        .progress { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 5px 0; }
        .bar { height: 100%; background: #28a745; width: 0%; transition: width 0.5s; }
        video, img, svg { max-width: 100%; margin: 10px auto; display: block; border-radius: 8px; }
        #video { width: 100%; height: 200px; background: #000; border-radius: 12px; }
        .hidden { display: none !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 16px; max-width: 90%; max-height: 90%; overflow-y: auto; }
        .small-modal { max-width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>إضافة عميل جديد</h1>
        <input type="text" id="name" placeholder="اسم العميل">
        <input type="text" id="phone" placeholder="رقم التليفون (مثال: 010...)">
        <input type="number" id="price" value="10000" placeholder="سعر السلعة">
        <input type="number" id="months" value="10" placeholder="عدد الشهور">
        <input type="number" id="interest" value="25" placeholder="نسبة الفائدة %">
        <button onclick="addClient()">إضافة عميل</button>
        <button onclick="exportPDF()">تصدير تقرير PDF</button>

        <h2>الأرباح الإجمالية</h2>
        <div id="res" class="result"></div>

        <h2>العملاء</h2>
        <div id="clientsTable"></div>
    </div>

    <!-- Modals -->
    <div id="editModal" class="modal hidden">...</div>
    <div id="paymentModal" class="modal hidden">...</div>
    <video id="video" class="hidden" autoplay playsinline></video>
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const { jsPDF } = window.jspdf;
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let currentClientIndex = -1;

        // تهيئة العملاء
        clients = clients.map(c => ({ ...c, price: +c.price || 0, months: +c.months || 0, interest: +c.interest || 0, paid: +c.paid || 0, payments: c.payments || [] }));

        // دوال أساسية (إضافة، تعديل، دفع، حذف، واتساب، كاميرا)
        // (نفس الكود السابق، مُختصر هنا للتركيز على PDF)

        function getLastPaymentDate(payments) {
            return payments?.length ? payments.at(-1).date : 'لا يوجد';
        }

        function getMonthlyProfit() {
            const now = new Date();
            const month = now.getMonth(), year = now.getFullYear();
            let profit = 0;
            clients.forEach(c => {
                const total = c.price * (1 + c.interest);
                const installment = total / c.months;
                const paidThisMonth = c.payments.reduce((sum, p) => {
                    const d = new Date(p.date);
                    return d.getMonth() === month && d.getFullYear() === year ? sum + p.amount : sum;
                }, 0);
                const profitThisMonth = paidThisMonth - installment;
                if (profitThisMonth > 0) profit += profitThisMonth;
            });
            return profit.toFixed(0);
        }

        // خط عربي مدمج (Noto Sans Arabic) - مختصر هنا، لكن في النسخة الحقيقية كامل
        const arabicFont = `AAEAAAARAQAABAAQFg...`; // 100,000+ حرف

        function exportPDF() {
            const doc = new jsPDF();

            // إضافة الخط العربي
            doc.addFileToVFS('arabic.ttf', arabicFont);
            doc.addFont('arabic.ttf', 'arabic', 'normal');
            doc.setFont('arabic');

            // العنوان
            doc.setFontSize(18);
            doc.text('تقرير العملاء - ' + new Date().toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' }), 105, 20, { align: 'center' });

            // الجدول
            doc.autoTable({
                head: [['الاسم', 'تليفون', 'مدفوع', 'متبقي', 'آخر قسط']],
                body: clients.map(c => {
                    const total = c.price * (1 + c.interest);
                    return [c.name, c.phone, c.paid + ' ج', (total - c.paid).toFixed(0) + ' ج', getLastPaymentDate(c.payments)];
                }),
                startY: 35,
                styles: { font: 'arabic', fontSize: 12 },
                headStyles: { fillColor: [40, 167, 69] },
                alternateRowStyles: { fillColor: [240, 248, 255] }
            });

            // أرباح الشهر
            const profit = getMonthlyProfit();
            doc.setFontSize(14);
            doc.setTextColor(0, 100, 0);
            doc.text(`الأرباح هذا الشهر: ${profit} جنيه`, 105, doc.lastAutoTable.finalY + 15, { align: 'center' });

            doc.save('تقرير_العملاء.pdf');
        }

        // باقي الدوال (addClient, edit, payment, etc.) نفس السابق
        // (مُختصرة هنا)

        window.onload = () => {
            calcProfits();
            showClients();
        };
    </script>
</body>
</html>
