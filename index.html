<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„ Ø§Ù„ØªÙ‚Ø³ÙŠØ·</title>

    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#28a745">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #f0f8ff;
            padding: 10px;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px;
        }
        h1, h2 {
            color: #28a745;
            text-align: center;
            margin: 20px 0 15px;
            font-size: 20px;
        }
        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #28a745;
            border-radius: 12px;
            font-size: 16px;
        }
        button {
            background: #28a745;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .btn {
            display: inline-block;
            width: auto;
            padding: 8px 12px;
            margin: 3px;
            font-size: 14px;
            border-radius: 8px;
        }
        .pay { background: #007bff; }
        .wa { background: #25D366; }
        .cam { background: #6f42c1; }
        .edit { background: #ffc107; color: black; }
        .del { background: #dc3545; }

        .result {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        th {
            background: #28a745;
            color: white;
            padding: 10px;
            font-size: 14px;
        }
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            background: #f9f9f9;
        }
        .progress {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin: 5px 0;
        }
        .bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.5s;
        }
        video, img, svg {
            max-width: 100%;
            margin: 10px auto;
            display: block;
            border-radius: 8px;
        }
        #video {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 12px;
        }
        .hidden { display: none !important; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 16px; max-width: 90%; max-height: 90%; overflow-y: auto;
        }
        .small-modal { max-width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h1>
        <input type="text" id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† (Ù…Ø«Ø§Ù„: 010...)">
        <input type="number" id="price" value="10000" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø³Ù„Ø¹Ø©">
        <input type="number" id="months" value="10" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡ÙˆØ±">
        <input type="number" id="interest" value="25" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© %">
        <button onclick="addClient()">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
        <button onclick="exportPDF()">ØªØµØ¯ÙŠØ± PDF</button>

        <h2>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h2>
        <div id="res" class="result"></div>

        <h2>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
        <div id="clientsTable"></div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
            <input type="text" id="editName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="text" id="editPhone" placeholder="Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†">
            <input type="number" id="editPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø³Ù„Ø¹Ø©">
            <input type="number" id="editMonths" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡ÙˆØ±">
            <input type="number" id="editInterest" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© %">
            <button onclick="saveClient()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            <button onclick="closeEditModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· -->
    <div id="paymentModal" class="modal hidden">
        <div class="modal-content small-modal">
            <h2>Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø·</h2>
            <input type="number" id="paymentAmount" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·">
            <input type="date" id="paymentDate">
            <button onclick="addPayment()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ø·</button>
            <button onclick="closePaymentModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <video id="video" class="hidden" autoplay playsinline></video>
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const { jsPDF } = window.jspdf;
        let stream;
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let currentClientIndex = -1;

        // ØªØ¸Ø¨ÙŠØ· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        clients = clients.map(c => ({
            ...c,
            price: parseFloat(c.price) || 0,
            months: parseInt(c.months) || 0,
            interest: parseFloat(c.interest) || 0,
            paid: parseFloat(c.paid) || 0,
            payments: c.payments || []
        }));

        function addClient() {
            let name = document.getElementById('name').value.trim();
            let phone = document.getElementById('phone').value.trim();
            let price = parseFloat(document.getElementById('price').value) || 10000;
            let months = parseInt(document.getElementById('months').value) || 10;
            let interest = parseFloat(document.getElementById('interest').value) || 25;

            if (!name || !phone) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†!');

            let clean = phone.replace(/[^0-9]/g, '');
            if (clean.startsWith('0')) clean = '20' + clean.slice(1);
            else if (clean.startsWith('1') && clean.length === 10) clean = '20' + clean;
            else if (!clean.startsWith('20')) clean = '20' + clean;
            phone = '+' + clean;

            let today = new Date();
            let endDate = new Date(today);
            endDate.setMonth(endDate.getMonth() + months);

            clients.push({
                name, phone,
                start: today.toLocaleDateString('ar-EG'),
                end: endDate.toLocaleDateString('ar-EG'),
                paid: 0,
                invoice: '',
                barcode: 'CL' + Date.now(),
                price: price,
                months: months,
                interest: interest / 100,
                payments: []
            });

            localStorage.setItem('clients', JSON.stringify(clients));
            document.getElementById('name').value = document.getElementById('phone').value = '';
            calcProfits();
            showClients();
            alert('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©!');
        }

        function editClient(i) {
            currentClientIndex = i;
            let c = clients[i];
            document.getElementById('editName').value = c.name;
            document.getElementById('editPhone').value = c.phone;
            document.getElementById('editPrice').value = c.price;
            document.getElementById('editMonths').value = c.months;
            document.getElementById('editInterest').value = (c.interest * 100).toFixed(0);
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function saveClient() {
            let c = clients[currentClientIndex];
            c.name = document.getElementById('editName').value.trim();
            c.phone = document.getElementById('editPhone').value.trim();
            c.price = parseFloat(document.getElementById('editPrice').value) || 0;
            c.months = parseInt(document.getElementById('editMonths').value) || 0;
            c.interest = (parseFloat(document.getElementById('editInterest').value) || 0) / 100;

            localStorage.setItem('clients', JSON.stringify(clients));
            closeEditModal();
            calcProfits();
            showClients();
            alert('ØªÙ… Ø§Ù„Ø­ÙØ¸!');
        }

        function openPaymentModal(i) {
            currentClientIndex = i;
            let today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        function addPayment() {
            let amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            let date = document.getElementById('paymentDate').value;
            if (!amount || !date) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ù‚Ø³Ø· ÙˆØªØ§Ø±ÙŠØ®Ù‡!');

            let c = clients[currentClientIndex];
            c.payments.push({ amount, date });
            c.paid += amount;

            localStorage.setItem('clients', JSON.stringify(clients));
            closePaymentModal();
            calcProfits();
            showClients();
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ø·!');
        }

        function calcProfits() {
            let totalProfit = 0;
            clients.forEach(c => {
                let totalAmount = c.price * (1 + (c.interest || 0));
                let profit = totalAmount - c.price;
                totalProfit += isNaN(profit) ? 0 : profit;
            });

            document.getElementById('res').innerHTML = `
                <p>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${totalProfit.toFixed(0)} Ø¬Ù†ÙŠÙ‡</p>
            `;
        }

        function deleteClient(i) {
            if (confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) {
                clients.splice(i, 1);
                localStorage.setItem('clients', JSON.stringify(clients));
                calcProfits();
                showClients();
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù‚Ø§Ø¯Ù…
        function getNextDueDate(payments) {
            if (!payments || payments.length === 0) {
                // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¯ÙØ¹Ø§ØªØŒ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ Ø´Ù‡Ø± Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                let start = new Date();
                start.setMonth(start.getMonth() + 1);
                return start.toLocaleDateString('ar-EG');
            }

            // Ø¢Ø®Ø± Ø¯ÙØ¹Ø© + Ø´Ù‡Ø±
            let lastPayment = payments[payments.length - 1];
            let lastDate = new Date(lastPayment.date);
            let nextDate = new Date(lastDate);
            nextDate.setMonth(nextDate.getMonth() + 1);
            return nextDate.toLocaleDateString('ar-EG');
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
        function getRemainingInstallments(c) {
            let totalAmount = c.price * (1 + c.interest);
            let monthly = totalAmount / c.months;
            let paidInstallments = Math.floor(c.paid / monthly);
            return Math.max(0, c.months - paidInstallments);
        }

        function sendWA(i) {
            let c = clients[i];
            let totalAmount = c.price * (1 + c.interest);
            let remainingAmount = totalAmount - c.paid;
            let remainingInstallments = getRemainingInstallments(c);
            let nextDueDate = getNextDueDate(c.payments);

            let msg = `Ù…Ø±Ø­Ø¨Ø§ ${c.name}ØŒ

ğŸ“Œ *ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø³ÙŠØ·:*
- Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: *${remainingAmount.toFixed(0)} Ø¬Ù†ÙŠÙ‡*
- Ø¨Ø§Ù‚ÙŠ Ù„Ùƒ: *${remainingInstallments} Ù‚Ø³Ø·*
- Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ø³ØªØ­Ù‚ ÙÙŠ: *${nextDueDate}*
Ø§Ø¯ÙØ¹ Ø¯Ù„ÙˆÙ‚ØªÙŠ 
!`;

            let phoneClean = c.phone.replace(/[^0-9]/g, '');
            window.open('https://wa.me/' + phoneClean + '?text=' + encodeURIComponent(msg), '_blank');
        }

        function capturePhoto(i) {
            if (!navigator.mediaDevices?.getUserMedia) return alert('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
                stream = s;
                let v = document.getElementById('video');
                v.classList.remove('hidden');
                v.srcObject = stream;
                alert('ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§... Ø³ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ');
                setTimeout(() => {
                    let canvas = document.getElementById('canvas');
                    canvas.width = v.videoWidth || 640;
                    canvas.height = v.videoHeight || 480;
                    canvas.getContext('2d').drawImage(v, 0, 0);
                    clients[i].invoice = canvas.toDataURL('image/jpeg', 0.8);
                    localStorage.setItem('clients', JSON.stringify(clients));
                    stream.getTracks().forEach(t => t.stop());
                    v.classList.add('hidden');
                    showClients();
                    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©!');
                }, 3000);
            }).catch(() => alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'));
        }

        function showClients() {
            let t = `<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>ØªÙ„ÙŠÙÙˆÙ†</th><th>ØµÙˆØ±Ø©</th><th>Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ù…Ø¯ÙÙˆØ¹</th><th>Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
            if (!clients.length) t += `<tr><td colspan="7" style="color:#999">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</td></tr>`;
            clients.forEach((c, i) => {
                let totalAmount = c.price * (1 + (c.interest || 0));
                let rem = totalAmount - c.paid;
                let pct = totalAmount > 0 ? (c.paid / totalAmount) * 100 : 0;
                let img = c.invoice ? `<img src="${c.invoice}" width="40" style="border-radius:6px">` : '';
                t += `<tr>
                    <td>${c.name}</td><td>${c.phone}</td>
                    <td>${img} <button class="btn cam" onclick="capturePhoto(${i})">ÙƒØ§Ù…ÙŠØ±Ø§</button></td>
                    <td><svg id="bc${i}" style="height:40px"></svg></td>
                    <td>${c.paid}</td><td>${isNaN(rem) ? 0 : rem.toFixed(0)}</td>
                    <td>
                        <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
                        <button class="btn pay" onclick="openPaymentModal(${i})">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø·</button>
                        <button class="btn edit" onclick="editClient(${i})">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn wa" onclick="sendWA(${i})">ÙˆØ§ØªØ³Ø§Ø¨</button>
                        <button class="btn del" onclick="deleteClient(${i})">Ø­Ø°Ù</button>
                    </td>
                </tr>`;
                setTimeout(() => JsBarcode(`#bc${i}`, c.barcode, { format: "CODE128", height: 40, displayValue: true, fontSize: 12 }), 100);
            });
            t += `</table>`;
            document.getElementById('clientsTable').innerHTML = t;
        }

        function exportPDF() {
            const doc = new jsPDF();
            doc.text('Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØªÙ‚Ø³ÙŠØ·', 105, 15, { align: 'center' });
            let y = 25;
            clients.forEach((c, i) => {
                let total = c.price * (1 + (c.interest || 0));
                doc.text(`${i+1}. ${c.name} | ${c.phone} | Ù…Ø¯ÙÙˆØ¹: ${c.paid} | Ù…ØªØ¨Ù‚ÙŠ: ${(total - c.paid).toFixed(0)}`, 10, y);
                y += 8;
            });
            doc.save('Ø¹Ù…Ù„Ø§Ø¡.pdf');
        }

        window.onload = () => {
            calcProfits();
            showClients();
        };
    </script>
</body>
</html>
