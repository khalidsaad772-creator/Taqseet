<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محل التقسيط</title>

    <!-- PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#28a745">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f8ff; padding: 10px; font-size: 16px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 20px; }
        h1, h2 { color: #28a745; text-align: center; margin: 20px 0 15px; font-size: 20px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #28a745; border-radius: 12px; font-size: 16px; }
        button { background: #28a745; color: white; font-weight: bold; cursor: pointer; }
        .btn { display: inline-block; width: auto; padding: 8px 12px; margin: 3px; font-size: 14px; border-radius: 8px; }
        .pay { background: #007bff; }
        .wa { background: #25D366; }
        .cam { background: #6f42c1; }
        .edit { background: #ffc107; color: black; }
        .del { background: #dc3545; }
        .payments { background: #17a2b8; color: white; }
        .calc-all { background: #6c757d; color: white; }

        .result { background: #d4edda; color: #155724; padding: 15px; border-radius: 12px; margin: 15px 0; text-align: center; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 14px; }
        th { background: #28a745; color: white; padding: 10px; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; background: #f9f9f9; }
        .progress { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 5px 0; }
        .bar { height: 100%; background: #28a745; width: 0%; transition: width 0.5s; }
        .hidden { display: none; }
        #video { width: 100%; height: 200px; background: #000; border-radius: 12px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 16px; max-width: 90%; max-height: 90%; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>إضافة عميل جديد</h1>
        <input type="text" id="name" placeholder="اسم العميل">
        <input type="text" id="phone" placeholder="رقم التليفون (مثال: 010...)">
        <input type="number" id="price" value="10000" placeholder="سعر السلعة">
        <input type="number" id="months" value="10" placeholder="عدد الشهور">
        <input type="number" id="interest" value="25" placeholder="نسبة الفائدة %">
        <button onclick="addClient()">إضافة عميل</button>
        <button class="calc-all" onclick="showAllCalculations()">عرض الحسابات الكلية</button>

        <h2>الأرباح الإجمالية</h2>
        <div id="res" class="result"></div>

        <h2>العملاء</h2>
        <div id="clientsTable"></div>
    </div>

    <!-- نافذة الدفعات -->
    <div id="paymentModal" class="modal hidden">
        <div class="modal-content">
            <h2>سجل الدفعات</h2>
            <input type="number" id="paymentAmount" placeholder="قيمة القسط">
            <input type="date" id="paymentDate">
            <button onclick="addPayment()">إضافة دفعة</button>
            <div id="paymentsList"></div>
            <button onclick="closeModal()">إغلاق</button>
        </div>
    </div>

    <video id="video" class="hidden" autoplay playsinline></video>
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const { jsPDF } = window.jspdf;
        let stream;
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let currentClientIndex = -1;

        function addClient() {
            let name = document.getElementById('name').value.trim();
            let phone = document.getElementById('phone').value.trim();
            let price = +document.getElementById('price').value || 10000;
            let months = +document.getElementById('months').value || 10;
            let interest = (+document.getElementById('interest').value || 25) / 100;

            if (!name || !phone) return alert('اكتب الاسم ورقم التليفون!');

            let clean = phone.replace(/[^0-9]/g, '');
            if (clean.startsWith('0')) clean = '20' + clean.slice(1);
            else if (clean.startsWith('1') && clean.length === 10) clean = '20' + clean;
            else if (!clean.startsWith('20')) clean = '20' + clean;
            phone = '+' + clean;

            let today = new Date();
            let endDate = new Date(today); endDate.setMonth(endDate.getMonth() + months);

            clients.push({
                name, phone,
                start: today.toLocaleDateString('ar-EG'),
                end: endDate.toLocaleDateString('ar-EG'),
                paid: 0,
                invoice: '',
                barcode: 'CL' + Date.now(),
                price, months, interest,
                payments: [] // سجل الدفعات
            });

            localStorage.setItem('clients', JSON.stringify(clients));
            document.getElementById('name').value = document.getElementById('phone').value = '';
            calcProfits();
            showClients();
            alert('تم الإضافة!');
        }

        function addPayment() {
            let amount = +document.getElementById('paymentAmount').value;
            let date = document.getElementById('paymentDate').value;
            if (!amount || !date) return alert('اكتب القسط وتاريخه!');

            let c = clients[currentClientIndex];
            c.payments.push({ amount, date });
            c.paid += amount;

            localStorage.setItem('clients', JSON.stringify(clients));
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentDate').value = '';
            showPayments();
            calcProfits();
            showClients();
        }

        function showPayments() {
            let c = clients[currentClientIndex];
            let t = `<table><tr><th>التاريخ</th><th>القسط</th></tr>`;
            c.payments.forEach(p => t += `<tr><td>${p.date}</td><td>${p.amount}</td></tr>`);
            t += `<tr><td><b>الإجمالي</b></td><td><b>${c.paid}</b></td></tr></table>`;
            document.getElementById('paymentsList').innerHTML = t;
        }

        function openPayments(i) {
            currentClientIndex = i;
            document.getElementById('paymentModal').classList.remove('hidden');
            let today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
            showPayments();
        }

        function closeModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        function calcProfits() {
            let totalProfit = 0;
            clients.forEach(c => {
                let totalAmount = c.price * (1 + c.interest);
                let profit = totalAmount - c.price;
                totalProfit += profit;
            });

            document.getElementById('res').innerHTML = `
                <p>الأرباح الإجمالية: ${totalProfit.toFixed(0)} جنيه</p>
            `;
        }

        function showAllCalculations() {
            let modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>الحسابات الكلية</h2>
                    <div id="allCalc"></div>
                    <button onclick="this.parentElement.parentElement.remove()">إغلاق</button>
                </div>
            `;
            document.body.appendChild(modal);

            let totalCapital = 0, totalPhones = 0, totalCollected = 0, totalProfit = 0;
            let his = [];

            clients.forEach(c => {
                let ini = 1; // كل عميل = سلعة واحدة
                let pri = c.price;
                let rat = c.interest;
                let mon = c.months;
                let pay = pri * (1 + rat) / mon;

                let act = ini, cas = 0, coll = 0;
                for (let m = 1; m <= mon; m++) {
                    let inc = act * pay;
                    coll += inc; cas += inc;
                    let nw = Math.floor(cas / pri);
                    cas -= nw * pri;
                    if (m < mon) act += nw;
                }
                totalCapital += pri;
                totalPhones += ini;
                totalCollected += coll + cas;
                totalProfit += coll + cas - pri;
            });

            let t = `<p><b>رأس المال:</b> ${totalCapital}</p>`;
            t += `<p><b>عدد السلع:</b> ${totalPhones}</p>`;
            t += `<p><b>الأرباح:</b> ${totalProfit.toFixed(0)} جنيه</p>`;
            t += `<p><b>الإجمالي:</b> ${(totalCapital + totalProfit).toFixed(0)} جنيه</p>`;
            document.getElementById('allCalc').innerHTML = t;
        }

        function updatePaid(i) { openPayments(i); }
        function editClient(i) { /* موجود بالكود السابق */ }
        function deleteClient(i) {
            if (confirm('حذف العميل؟')) {
                clients.splice(i, 1);
                localStorage.setItem('clients', JSON.stringify(clients));
                calcProfits();
                showClients();
            }
        }

        function sendWA(i) {
            let c = clients[i];
            let totalAmount = c.price * (1 + c.interest);
            let rem = totalAmount - c.paid;
            let days = Math.ceil((new Date(c.end.split('/').reverse().join('-')) - new Date()) / 86400000);
            let msg = 'مرحبا ' + c.name + '، قسطك متبقي ' + rem.toFixed(0) + ' جنيه، هينتهي بعد ' + days + ' يوم! ادفع دلوقتي';
            let phoneClean = c.phone.replace(/[^0-9]/g, '');
            window.open('https://wa.me/' + phoneClean + '?text=' + encodeURIComponent(msg), '_blank');
        }

        function capturePhoto(i) { /* موجود بالكود السابق */ }

        function showClients() {
            let t = `<table><tr><th>الاسم</th><th>تليفون</th><th>صورة</th><th>باركود</th><th>مدفوع</th><th>متبقي</th><th>إجراء</th></tr>`;
            if (!clients.length) t += `<tr><td colspan="7" style="color:#999">لا يوجد عملاء</td></tr>`;
            clients.forEach((c, i) => {
                let totalAmount = c.price * (1 + c.interest);
                let rem = totalAmount - c.paid;
                let pct = (c.paid / totalAmount) * 100;
                let img = c.invoice ? `<img src="${c.invoice}" width="40" style="border-radius:6px">` : '';
                t += `<tr>
                    <td>${c.name}</td><td>${c.phone}</td>
                    <td>${img} <button class="btn cam" onclick="capturePhoto(${i})">كاميرا</button></td>
                    <td><svg id="bc${i}" style="height:40px"></svg></td>
                    <td>${c.paid}</td><td>${rem.toFixed(0)}</td>
                    <td>
                        <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
                        <button class="btn payments" onclick="openPayments(${i})">دفعات</button>
                        <button class="btn wa" onclick="sendWA(${i})">واتساب</button>
                        <button class="btn del" onclick="deleteClient(${i})">حذف</button>
                    </td>
                </tr>`;
                setTimeout(() => JsBarcode(`#bc${i}`, c.barcode, { format: "CODE128", height: 40, displayValue: true, fontSize: 12 }), 100);
            });
            t += `</table>`;
            document.getElementById('clientsTable').innerHTML = t;
        }

        function exportPDF() {
            const doc = new jsPDF();
            doc.text('عملاء التقسيط', 105, 15, { align: 'center' });
            let y = 25;
            clients.forEach((c, i) => {
                let total = c.price * (1 + c.interest);
                doc.text(`${i+1}. ${c.name} | ${c.phone} | مدفوع: ${c.paid} | متبقي: ${(total - c.paid).toFixed(0)}`, 10, y);
                y += 8;
            });
            doc.save('عملاء.pdf');
        }

        window.onload = () => {
            calcProfits();
            showClients();
        };
    </script>
</body>
</html>
