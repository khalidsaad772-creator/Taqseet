<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„ Ø§Ù„ØªÙ‚Ø³ÙŠØ·</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f8ff; padding: 10px; font-size: 16px; line-height: 1.6; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 20px; }
        h1, h2 { color: #28a745; text-align: center; margin: 20px 0 15px; font-size: 20px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #28a745; border-radius: 12px; font-size: 16px; }
        button { background: #28a745; color: white; font-weight: bold; cursor: pointer; }
        .btn { display: inline-block; width: auto; padding: 8px 12px; margin: 3px; font-size: 14px; border-radius: 8px; }
        .pay { background: #007bff; } .wa { background: #25D366; } .edit { background: #ffc107; color: black; } .del { background: #dc3545; }
        .result { background: #d4edda; color: #155724; padding: 15px; border-radius: 12px; margin: 15px 0; text-align: center; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 14px; }
        th { background: #28a745; color: white; padding: 10px; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; background: #f9f9f9; }
        .progress { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 5px 0; }
        .bar { height: 100%; background: #28a745; width: 0%; transition: width 0.5s; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 16px; max-width: 90%; max-height: 90%; overflow-y: auto; }
        .small-modal { max-width: 300px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h1>
        <input type="text" id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†">
        <input type="number" id="price" value="10000" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø³Ù„Ø¹Ø©">
        <input type="number" id="months" value="10" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡ÙˆØ±">
        <input type="number" id="interest" value="25" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© %">
        <button onclick="addClient()">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
        <button onclick="exportPDF()">ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± PDF</button>

        <h2>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h2>
        <div id="res" class="result"></div>

        <h2>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
        <div id="clientsTable"></div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
            <input type="text" id="editName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="text" id="editPhone" placeholder="Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†">
            <input type="number" id="editPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø³Ù„Ø¹Ø©">
            <input type="number" id="editMonths" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡ÙˆØ±">
            <input type="number" id="editInterest" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© %">
            <button onclick="saveClient()">Ø­ÙØ¸</button>
            <button onclick="closeEditModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹ -->
    <div id="paymentModal" class="modal hidden">
        <div class="modal-content small-modal">
            <h2>Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø·</h2>
            <input type="number" id="paymentAmount" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·">
            <input type="date" id="paymentDate">
            <button onclick="addPayment()">Ø¥Ø¶Ø§ÙØ©</button>
            <button onclick="closePaymentModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let currentClientIndex = -1;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        clients = clients.map(c => ({ 
            ...c, 
            price: +c.price || 0, 
            months: +c.months || 0, 
            interest: +c.interest || 0, 
            paid: +c.paid || 0, 
            payments: c.payments || [] 
        }));

        function addClient() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const price = +document.getElementById('price').value || 10000;
            const months = +document.getElementById('months').value || 10;
            const interest = +document.getElementById('interest').value || 25;
            if (!name || !phone) return alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!');

            const clean = phone.replace(/[^0-9]/g, '');
            const full = clean.startsWith('20') ? clean : '20' + clean.replace(/^0/, '');
            const formattedPhone = '+' + full;

            const today = new Date();
            const endDate = new Date(today);
            endDate.setMonth(endDate.getMonth() + months);

            clients.push({
                name, 
                phone: formattedPhone, 
                start: today.toLocaleDateString('ar-EG'), 
                end: endDate.toLocaleDateString('ar-EG'),
                price, 
                months, 
                interest: interest / 100, 
                paid: 0, 
                payments: [], 
                barcode: 'CL' + Date.now(), 
                invoice: ''
            });

            localStorage.setItem('clients', JSON.stringify(clients));
            document.getElementById('name').value = document.getElementById('phone').value = '';
            calcProfits(); showClients(); alert('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©!');
        }

        function calcProfits() {
            const total = clients.reduce((sum, c) => sum + (c.price * c.interest), 0);
            document.getElementById('res').innerHTML = `<p>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${total.toFixed(0)} Ø¬Ù†ÙŠÙ‡</p>`;
        }

        function showClients() {
            let html = `<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>ØªÙ„ÙŠÙÙˆÙ†</th><th>Ù…Ø¯ÙÙˆØ¹</th><th>Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
            if (!clients.length) html += `<tr><td colspan="5" style="color:#999">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</td></tr>`;
            clients.forEach((c, i) => {
                const total = c.price * (1 + c.interest);
                const rem = total - c.paid;
                const pct = total ? (c.paid / total) * 100 : 0;
                html += `<tr>
                    <td>${c.name}</td><td>${c.phone}</td>
                    <td>${c.paid}</td><td>${rem.toFixed(0)}</td>
                    <td>
                        <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
                        <button class="btn pay" onclick="openPaymentModal(${i})">Ù‚Ø³Ø·</button>
                        <button class="btn edit" onclick="editClient(${i})">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn wa" onclick="sendWA(${i})">ÙˆØ§ØªØ³</button>
                        <button class="btn del" onclick="deleteClient(${i})">Ø­Ø°Ù</button>
                    </td>
                </tr>`;
            });
            html += `</table>`;
            document.getElementById('clientsTable').innerHTML = html;
        }

        function deleteClient(i) { if (confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) { clients.splice(i,1); localStorage.setItem('clients', JSON.stringify(clients)); calcProfits(); showClients(); } }
        function editClient(i) { currentClientIndex = i; const c = clients[i]; document.getElementById('editName').value = c.name; document.getElementById('editPhone').value = c.phone.replace('+', ''); document.getElementById('editPrice').value = c.price; document.getElementById('editMonths').value = c.months; document.getElementById('editInterest').value = (c.interest * 100).toFixed(0); document.getElementById('editModal').classList.remove('hidden'); }
        function saveClient() { const c = clients[currentClientIndex]; c.name = document.getElementById('editName').value.trim(); c.phone = '+' + document.getElementById('editPhone').value.trim().replace(/[^0-9]/g, ''); c.price = +document.getElementById('editPrice').value; c.months = +document.getElementById('editMonths').value; c.interest = (+document.getElementById('editInterest').value) / 100; localStorage.setItem('clients', JSON.stringify(clients)); closeEditModal(); calcProfits(); showClients(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸!'); }
        function openPaymentModal(i) { currentClientIndex = i; document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0]; document.getElementById('paymentModal').classList.remove('hidden'); }
        function addPayment() { const amount = +document.getElementById('paymentAmount').value; const date = document.getElementById('paymentDate').value; if (!amount || !date) return alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„!'); clients[currentClientIndex].payments.push({amount, date}); clients[currentClientIndex].paid += amount; localStorage.setItem('clients', JSON.stringify(clients)); closePaymentModal(); calcProfits(); showClients(); alert('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©!'); }
        function closePaymentModal() { document.getElementById('paymentModal').classList.add('hidden'); }
        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        // === Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© 100% (Ø²ÙŠ Ø§Ù„Ù…Ø«Ø§Ù„ Ø¨Ø§Ù„Ø¶Ø¨Ø·) ===
        function sendWA(i) {
            const c = clients[i];
            const totalPrice = c.price * (1 + c.interest);
            const remainingAmount = totalPrice - c.paid;
            const installmentValue = totalPrice / c.months;
            const paidInstallments = Math.floor(c.paid / installmentValue);
            const remainingInstallments = c.months - paidInstallments;

            // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù‚Ø§Ø¯Ù…
            const startDate = new Date(c.start.split('/').reverse().join('-'));
            const nextDue = new Date(startDate);
            nextDue.setMonth(startDate.getMonth() + paidInstallments + 1);
            const nextDueStr = nextDue.toLocaleDateString('ar-EG');

            const msg = `Ù…Ø±Ø­Ø¨Ø§ ${c.name}ØŒ

ğŸ“Œ *ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø³ÙŠØ·:*
- Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: *${remainingAmount.toFixed(0)} Ø¬Ù†ÙŠÙ‡*
- Ø¨Ø§Ù‚ÙŠ Ù„Ùƒ: *${remainingInstallments} Ù‚Ø³Ø·*
- Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ø³ØªØ­Ù‚ ÙÙŠ: *${nextDueStr}*
Ø§Ø¯ÙØ¹ Ø¯Ù„ÙˆÙ‚ØªÙŠ 
!ğŸ˜`;

            const phoneClean = c.phone.replace('+', '');
            const encodedMsg = encodeURIComponent(msg);
            window.open(`https://wa.me/${phoneClean}?text=${encodedMsg}`, '_blank');
        }

        // === PDF Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙÙˆØ±ÙŠ ===
        function exportPDF() {
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text('Clients Report - ' + new Date().toLocaleDateString(), 105, 20, { align: 'center' });

            doc.autoTable({
                head: [['Name', 'Phone', 'Paid', 'Remaining', 'Last Payment']],
                body: clients.map(c => {
                    const total = c.price * (1 + c.interest);
                    return [c.name, c.phone, c.paid + ' EGP', (total - c.paid).toFixed(0) + ' EGP', getLastPayment(c.payments)];
                }),
                startY: 35,
                styles: { fontSize: 12, cellPadding: 5 },
                headStyles: { fillColor: [40, 167, 69], textColor: 255 },
                alternateRowStyles: { fillColor: [240, 248, 255] }
            });

            const profit = getMonthlyProfit();
            doc.setFontSize(14);
            doc.setTextColor(0, 100, 0);
            doc.text(`This Month Profit: ${profit} EGP`, 105, doc.lastAutoTable.finalY + 15, { align: 'center' });

            doc.save('ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.pdf');
        }

        function getLastPayment(payments) { return payments?.length ? payments.at(-1).date : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'; }

        function getMonthlyProfit() {
            const now = new Date();
            const month = now.getMonth(), year = now.getFullYear();
            return clients.reduce((p, c) => {
                const total = c.price * (1 + c.interest);
                const installment = total / c.months;
                const paid = c.payments.reduce((s, pay) => {
                    const d = new Date(pay.date);
                    return d.getMonth() === month && d.getFullYear() === year ? s + pay.amount : s;
                }, 0);
                return p + Math.max(0, paid - installment);
            }, 0).toFixed(0);
        }

        window.onload = () => { calcProfits(); showClients(); };
    </script>
</body>
</html>
