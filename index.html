<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محل التقسيط الذكي</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f8ff; padding: 10px; font-size: 16px; line-height: 1.6; }
        .container { max-width: 520px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 20px; }
        h1 { color: #28a745; text-align: center; margin: 15px 0 20px; font-size: 24px; }
        h2 { color: #28a745; text-align: center; margin: 20px 0 10px; font-size: 20px; }
        input, button { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid #28a745; border-radius: 12px; font-size: 16px; }
        button { background: #28a745; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.9; }
        .backup-btn { background: #ff9800 !important; }
        .restore-btn { background: #9c27b0 !important; }
        .btn { padding: 8px 12px; margin: 4px 2px; font-size: 14px; border-radius: 10px; font-weight: bold; }
        .pay { background: #007bff; }
        .wa { background: #25D366; }
        .cam { background: #6f42c1; }
        .edit { background: #ffc107; color: black; }
        .del { background: #dc3545; }
        .upload-photo { background: #17a2b8; }

        .result { background: #d4edda; color: #155724; padding: 16px; border-radius: 12px; margin: 15px 0; text-align: center; font-size: 18px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 13.5px; }
        th { background: #28a745; color: white; padding: 10px 6px; font-size: 13px; }
        td { border: 1px solid #ddd; padding: 8px 6px; text-align: center; vertical-align: middle; }
        .client-row td { background: #f9f9f9; font-weight: bold; }
        .action-row { background: #e9ecef; }
        .action-content { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; align-items: center; padding: 8px 0; }
        .progress { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 6px 0; }
        .bar { height: 100%; background: #28a745; transition: width 0.6s ease; }
        .next-installment { color: #d39e00; font-weight: bold; font-size: 15px; }
        .product-desc { font-size: 12.5px; color: #555; display: block; margin-top: 3px; }
        .client-thumb { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; border: 3px solid #28a745; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .hidden { display: none !important; }
        .full-image { max-width: 100%; max-height: 80vh; border-radius: 12px; }
        #capturedImage, #uploadedImage { max-width: 100%; margin-top: 15px; border-radius: 12px; border: 3px solid #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>محل التقسيط الذكي</h1>

        <input type="text" id="name" placeholder="اسم العميل">
        <input type="text" id="phone" placeholder="رقم التليفون (بدون +20)">
        <input type="text" id="product" placeholder="وصف المنتج (تليفزيون – تلاجة – موبايل...)">
        <input type="number" id="price" value="10000" placeholder="سعر السلعة">
        <input type="number" id="months" value="10" placeholder="عدد الشهور">
        <input type="number" id="interest" value="25" placeholder="نسبة الفائدة %">

        <button onclick="addClient()">إضافة عميل جديد</button>
        <button onclick="exportPDF()">تصدير تقرير PDF</button>
        <button class="backup-btn" onclick="exportData()">تصدير البيانات (نسخة احتياطية)</button>
        <button class="restore-btn" onclick="document.getElementById('restoreInput').click()">استعادة البيانات</button>
        <input type="file" id="restoreInput" accept=".json" onchange="restoreData(event)" style="display:none;">

        <h2>الأرباح الفائدة الإجمالية</h2>
        <div id="res" class="result">جاري الحساب...</div>

        <h2 id="clientsCount">قائمة العملاء (0)</h2>
        <div id="clientsTable"></div>
    </div>

    <!-- مودال التعديل -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <h2>تعديل بيانات العميل</h2>
            <input type="text" id="editName">
            <input type="text" id="editPhone">
            <input type="text" id="editProduct">
            <input type="number" id="editPrice">
            <input type="number" id="editMonths">
            <input type="number" id="editInterest">
            <button onclick="saveClient()">حفظ التعديلات</button>
            <button onclick="closeEditModal()" style="background:#dc3545;">إغلاق</button>
        </div>
    </div>

    <!-- مودال الدفع -->
    <div id="paymentModal" class="modal hidden">
        <div class="modal-content">
            <h2>إضافة قسط</h2>
            <input type="number" id="paymentAmount" placeholder="قيمة القسط">
            <input type="date" id="paymentDate">
            <button onclick="addPayment()">إضافة القسط</button>
            <button onclick="closePaymentModal()" style="background:#dc3545;">إغلاق</button>
        </div>
    </div>

    <!-- مودال الكاميرا + تحميل صورة -->
    <div id="cameraModal" class="modal hidden">
        <div class="modal-content">
            <h2>صورة العميل أو الفاتورة</h2>
            <video id="video" width="300" height="300" autoplay style="border-radius:12px;"></video>
            <canvas id="canvas" class="hidden"></canvas>
            <img id="capturedImage" class="hidden">
            <img id="uploadedImage" class="hidden">
            <div style="margin-top:15px;">
                <button onclick="startCamera()">ابدأ الكاميرا</button>
                <button onclick="takePhoto()">التقاط</button>
                <button class="upload-photo" onclick="document.getElementById('photoUpload').click()">تحميل من الجوال</button>
                <input type="file" id="photoUpload" accept="image/*" onchange="uploadPhoto(event)" style="display:none;">
                <button onclick="savePhoto()" style="background:#28a745;margin-top:10px;">حفظ الصورة</button>
                <button onclick="closeCameraModal()" style="background:#dc3545;margin-top:10px;">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- مودال عرض الصورة كاملة -->
    <div id="imageModal" class="modal hidden">
        <div class="modal-content">
            <img id="fullImage" class="full-image">
            <button onclick="closeImageModal()" style="margin-top:15px;">إغلاق</button>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let currentClientIndex = -1;
        let stream = null;
        let capturedDataUrl = null;

        // تهيئة البيانات القديمة عشان ما يحصلش خطأ
        clients = clients.map(c => ({
            name: c.name || "",
            phone: c.phone || "",
            product: c.product || "بدون وصف",
            price: +c.price || 0,
            months: +c.months || 10,
            interest: (+c.interest || 25) / 100,
            paid: +c.paid || 0,
            payments: c.payments || [],
            photo: c.photo || null
        }));

        function addClient() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const product = document.getElementById('product').value.trim() || "بدون وصف";
            const price = +document.getElementById('price').value || 10000;
            const months = +document.getElementById('months').value || 10;
            const interest = (+document.getElementById('interest').value || 25) / 100;

            if (!name || !phone) return alert('اسم العميل ورقم التليفون مطلوبان!');

            const clean = phone.replace(/[^0-9]/g, '');
            const full = clean.startsWith('20') ? clean : '20' + clean.replace(/^0/, '');
            const formattedPhone = '+' + full;

            clients.push({
                name, phone: formattedPhone, product,
                price, months, interest, paid: 0, payments: [], photo: null
            });

            localStorage.setItem('clients', JSON.stringify(clients));
            document.getElementById('name').value = document.getElementById('phone').value = document.getElementById('product').value = '';
            calcProfits(); showClients(); alert('تم الإضافة بنجاح!');
        }

        function calcProfits() {
            const total = clients.reduce((sum, c) => sum + (c.price * c.interest), 0);
            document.getElementById('res').innerHTML = `أرباح الفائدة الإجمالية: ${total.toFixed(0)} جنيه`;
        }

        function getNextInstallment(c) {
            const total = c.price * (1 + c.interest);
            const installment = total / c.months;
            const paidInstallments = Math.floor(c.paid / installment);
            const remaining = c.months - paidInstallments;
            return remaining > 0 ? installment.toFixed(0) : "تم السداد";
        }

        function showClients() {
            document.getElementById('clientsCount').textContent = `قائمة العملاء (${clients.length})`;
            let html = `<table>
                <tr>
                    <th>الاسم و المنتج</th>
                    <th>التليفون</th>
                    <th>مدفوع</th>
                    <th>متبقي</th>
                    <th>القسط القادم</th>
                </tr>`;

            if (!clients.length) html += `<tr><td colspan="5" style="padding:20px;color:#999;">لا يوجد عملاء</td></tr>`;

            clients.forEach((c, i) => {
                const total = c.price * (1 + c.interest);
                const rem = total - c.paid;
                const pct = total ? (c.paid / total) * 100 : 0;
                const next = getNextInstallment(c);
                const thumb = c.photo ? `<img src="\( {c.photo}" class="client-thumb" onclick="openImageModal(' \){c.photo}')">` : '';

                html += `
                <tr class="client-row">
                    <td style="text-align:right;">
                        <div>${c.name}</div>
                        <span class="product-desc">${c.product}</span>
                    </td>
                    <td>${c.phone.replace('+20', '0')}</td>
                    <td>${c.paid.toFixed(0)}</td>
                    <td>${rem.toFixed(0)}</td>
                    <td class="next-installment">${next === "تم السداد" ? '<span style="color:green;">تم السداد</span>' : next + ' جنيه'}</td>
                </tr>
                <tr class="action-row">
                    <td colspan="5">
                        <div class="action-content">
                            <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
                            <button class="btn pay" onclick="openPaymentModal(${i})">قسط</button>
                            <button class="btn edit" onclick="editClient(${i})">تعديل</button>
                            <button class="btn wa" onclick="sendWA(${i})">واتس</button>
                            <button class="btn cam" onclick="openCameraModal(${i})">صورة</button>
                            ${thumb}
                            <button class="btn del" onclick="deleteClient(${i})">حذف</button>
                        </div>
                    </td>
                </tr>`;
            });
            html += `</table>`;
            document.getElementById('clientsTable').innerHTML = html;
        }

        function deleteClient(i) { if(confirm('تأكيد الحذف؟')) { clients.splice(i,1); localStorage.setItem('clients', JSON.stringify(clients)); calcProfits(); showClients(); } }
        function editClient(i) {
            currentClientIndex = i;
            const c = clients[i];
            document.getElementById('editName').value = c.name;
            document.getElementById('editPhone').value = c.phone.replace('+', '');
            document.getElementById('editProduct').value = c.product;
            document.getElementById('editPrice').value = c.price;
            document.getElementById('editMonths').value = c.months;
            document.getElementById('editInterest').value = (c.interest * 100).toFixed(0);
            document.getElementById('editModal').classList.remove('hidden');
        }
        function saveClient() {
            const c = clients[currentClientIndex];
            c.name = document.getElementById('editName').value.trim();
            c.phone = '+' + document.getElementById('editPhone').value.trim().replace(/[^0-9]/g, '');
            c.product = document.getElementById('editProduct').value.trim() || "بدون وصف";
            c.price = +document.getElementById('editPrice').value;
            c.months = +document.getElementById('editMonths').value;
            c.interest = (+document.getElementById('editInterest').value) / 100;
            localStorage.setItem('clients', JSON.stringify(clients));
            closeEditModal(); calcProfits(); showClients(); alert('تم الحفظ!');
        }
        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        function openPaymentModal(i) { currentClientIndex = i; document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0]; document.getElementById('paymentModal').classList.remove('hidden'); }
        function addPayment() 
            { const amt = +document.getElementById('paymentAmount').value; const date = document.getElementById('paymentDate').value; if(!amt||!date) return alert('املأ الحقول'); clients[currentClientIndex].payments.push({amount:amt,date}); clients[currentClientIndex].paid += amt; localStorage.setItem('clients', JSON.stringify(clients)); closePaymentModal(); calcProfits(); showClients(); alert('تم إضافة القسط'); }
        function closePaymentModal() { document.getElementById('paymentModal').classList.add('hidden'); }

        // واتس آب
        function sendWA(i) {
            const c = clients[i];
            const totalPrice = c.price * (1 + c.interest);
            const remaining = totalPrice - c.paid;
            const installment = totalPrice / c.months;
            const paidInst = Math.floor(c.paid / installment);
            const remInst = c.months - paidInst;

            const nextDue = new Date();
            nextDue.setMonth(nextDue.getMonth() + 1);
            const nextStr = nextDue.toLocaleDateString('ar-EG');

            const msg = `مرحبا \( {c.name}\n\nتفاصيل التقسيط:\n- المنتج: \){c.product}\n- المبلغ المتبقي: *\( {remaining.toFixed(0)} جنيه*\n- باقي \){remInst} قسط\n- القسط القادم مستحق يوم: *${nextStr}*\nشكرًا لتعاملك معانا`;

            const phoneClean = c.phone.replace('+', '');
            window.open(`https://wa.me/\( {phoneClean}?text= \){encodeURIComponent(msg)}`, '_blank');
        }

        // كاميرا + تحميل صورة
        function openCameraModal(i) {
            currentClientIndex = i; capturedDataUrl = null;
            document.getElementById('uploadedImage').classList.add('hidden');
            document.getElementById('capturedImage').classList.add('hidden');
            document.getElementById('cameraModal').classList.remove('hidden');
            startCamera();
        }
        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(s => { stream = s; document.getElementById('video').srcObject = stream; })
                .catch(() => alert("فشل فتح الكاميرا"));
        }
        function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = 300; canvas.height = 300;
            canvas.getContext('2d').drawImage(video, 0, 0, 300, 300);
            capturedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('capturedImage').src = capturedDataUrl;
            document.getElementById('capturedImage').classList.remove('hidden');
        }
        function uploadPhoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                capturedDataUrl = ev.target.result;
                document.getElementById('uploadedImage').src = capturedDataUrl;
                document.getElementById('uploadedImage').classList.remove('hidden');
                document.getElementById('capturedImage').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
        function savePhoto() {
            if (!capturedDataUrl) return alert("التقط أو احمل صورة أولاً");
            clients[currentClientIndex].photo = capturedDataUrl;
            localStorage.setItem('clients', JSON.stringify(clients));
            closeCameraModal(); showClients(); alert('تم حفظ الصورة');
        }
        function closeCameraModal() {
            document.getElementById('cameraModal').classList.add('hidden');
            if (stream) stream.getTracks().forEach(t => t.stop());
        }

        function openImageModal(src) {
            document.getElementById('fullImage').src = src;
            document.getElementById('imageModal').classList.remove('hidden');
        }
        function closeImageModal() { document.getElementById('imageModal').classList.add('hidden'); }

        // PDF
        function exportPDF() {
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text('تقرير العملاء - ' + new Date().toLocaleDateString('ar-EG'), 105, 20, {align:'center'});

            const body = clients.map(c => {
                const total = c.price * (1 + c.interest);
                return [
                    c.name + '\n' + c.product,
                    c.phone.replace('+20','0'),
                    c.paid + ' ج',
                    (total - c.paid).toFixed(0) + ' ج',
                    getNextInstallment(c)
                ];
            });

            doc.autoTable({
                head: [['الاسم والمنتج','التليفون','المدفوع','المتبقي','القسط القادم']],
                body: body,
                startY: 30,
                styles: { fontSize: 11, cellPadding: 4 },
                headStyles: { fillColor: [40,167,69] }
            });

            const profit = clients.reduce((s,c) => s + c.price * c.interest, 0);
            doc.setFontSize(16);
            doc.setTextColor(0,100,0);
            doc.text(`إجمالي أرباح الفائدة: ${profit.toFixed(0)} جنيه`, 105, doc.lastAutoTable.finalY + 15, {align:'center'});

            doc.save('تقرير_التقسيط.pdf');
        }

        // تصدير واستعادة البيانات
        function exportData() {
            const data = { clients, backupDate: new Date().toLocaleString('ar-EG') };
            const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `نسخة_تقسيط_${new Date().toISOString().split('T')[0]}.json`;
            a.click(); URL.revokeObjectURL(url);
            alert('تم التصدير بنجاح');
        }
        function restoreData(e) {
            const file = e.target.files[0];
            if (!file) retur
